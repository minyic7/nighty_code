%%{init: {'theme':'dark', 'themeVariables': { 'primaryColor':'#1f2937', 'primaryTextColor':'#fff', 'primaryBorderColor':'#7C3AED', 'lineColor':'#F59E0B', 'secondaryColor':'#6366F1', 'tertiaryColor':'#10B981'}}}%%

graph TB
    %% MCP Module - Model Context Protocol
    
    subgraph Request["ğŸ¯ Request Layer"]
        ToolCall["Tool Call<br/>- Name<br/>- Arguments<br/>- Context"]
        ResourceReq["Resource Request<br/>- URI<br/>- Type"]
        PromptReq["Prompt Request<br/>- Template<br/>- Variables"]
    end
    
    subgraph MCPManager["ğŸ›ï¸ MCP Manager"]
        ServerRegistry["Server Registry<br/>ğŸ“š Multiple Servers"]
        Router["Tool Router<br/>ğŸ”€ Dynamic Routing"]
        Discovery["Discovery Service<br/>ğŸ” Tool/Resource Discovery"]
    end
    
    subgraph Servers["ğŸ–¥ï¸ Server Implementations"]
        
        subgraph FSServer["ğŸ“ Filesystem Server"]
            FSTools["Tools:<br/>â€¢ read_file<br/>â€¢ write_file<br/>â€¢ list_directory<br/>â€¢ search_files<br/>â€¢ grep<br/>â€¢ diff_files"]
            FSSecurity["Security:<br/>ğŸ”’ Access Control<br/>ğŸ›¡ï¸ Path Validation<br/>ğŸ“ Size Limits"]
        end
        
        subgraph CustomServers["ğŸ”§ Custom Servers"]
            DBServer["Database Server<br/>â€¢ Query<br/>â€¢ Update"]
            APIServer["API Server<br/>â€¢ REST<br/>â€¢ GraphQL"]
            CompilerServer["Compiler Server<br/>â€¢ Build<br/>â€¢ Test"]
        end
    end
    
    subgraph Execution["âš¡ Execution Layer"]
        Validator["Parameter Validator<br/>âœ… Type Check<br/>âœ… Required Fields"]
        Executor["Safe Executor<br/>ğŸ” Sandboxed<br/>â±ï¸ Timeout Control"]
        ResultProcessor["Result Processor<br/>ğŸ“¦ Format Output<br/>ğŸ¨ Transform Data"]
    end
    
    subgraph Resources["ğŸ“š Resource Layer"]
        FileRes["File Resources<br/>ğŸ“„ Documents<br/>ğŸ’¾ Data Files"]
        PromptRes["Prompt Templates<br/>ğŸ“ Reusable<br/>ğŸ”„ Parameterized"]
        MetaRes["Metadata<br/>ğŸ“Š Schemas<br/>ğŸ·ï¸ Tags"]
    end
    
    subgraph Output["ğŸ“¤ Output"]
        ToolResult["Tool Result<br/>- Status<br/>- Content<br/>- Metadata"]
        ResourceData["Resource Data<br/>- Content<br/>- Type<br/>- URI"]
        Error["Error Handling<br/>- Type<br/>- Message<br/>- Recovery"]
    end
    
    %% Connections
    ToolCall --> MCPManager
    ResourceReq --> MCPManager
    PromptReq --> MCPManager
    
    MCPManager --> ServerRegistry
    ServerRegistry --> Router
    Router --> Discovery
    
    Discovery --> Servers
    
    FSServer --> Execution
    CustomServers --> Execution
    
    Execution --> Validator
    Validator --> Executor
    Executor --> ResultProcessor
    
    Resources --> FSServer
    Resources --> CustomServers
    
    ResultProcessor --> ToolResult
    ResultProcessor --> ResourceData
    Executor -.->|On Error| Error
    
    %% Feedback
    ToolResult -.->|Cache| MCPManager
    Error -.->|Retry| Router
    
    style Request fill:#1e293b,stroke:#3b82f6,stroke-width:2px
    style MCPManager fill:#1e3a5f,stroke:#60a5fa,stroke-width:2px
    style Servers fill:#312e4f,stroke:#8b5cf6,stroke-width:2px
    style Execution fill:#1e3a5f,stroke:#10b981,stroke-width:2px
    style Resources fill:#374151,stroke:#f59e0b,stroke-width:2px
    style Output fill:#1e293b,stroke:#ef4444,stroke-width:2px