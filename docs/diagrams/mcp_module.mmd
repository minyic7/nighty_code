%%{init: {'theme':'dark', 'themeVariables': { 'primaryColor':'#1f2937', 'primaryTextColor':'#fff', 'primaryBorderColor':'#7C3AED', 'lineColor':'#F59E0B', 'secondaryColor':'#6366F1', 'tertiaryColor':'#10B981'}}}%%

graph TB
    %% MCP Module - Model Context Protocol
    
    subgraph Request["🎯 Request Layer"]
        ToolCall["Tool Call<br/>- Name<br/>- Arguments<br/>- Context"]
        ResourceReq["Resource Request<br/>- URI<br/>- Type"]
        PromptReq["Prompt Request<br/>- Template<br/>- Variables"]
    end
    
    subgraph MCPManager["🎛️ MCP Manager"]
        ServerRegistry["Server Registry<br/>📚 Multiple Servers"]
        Router["Tool Router<br/>🔀 Dynamic Routing"]
        Discovery["Discovery Service<br/>🔍 Tool/Resource Discovery"]
    end
    
    subgraph Servers["🖥️ Server Implementations"]
        
        subgraph FSServer["📁 Filesystem Server"]
            FSTools["Tools:<br/>• read_file<br/>• write_file<br/>• list_directory<br/>• search_files<br/>• grep<br/>• diff_files"]
            FSSecurity["Security:<br/>🔒 Access Control<br/>🛡️ Path Validation<br/>📏 Size Limits"]
        end
        
        subgraph CustomServers["🔧 Custom Servers"]
            DBServer["Database Server<br/>• Query<br/>• Update"]
            APIServer["API Server<br/>• REST<br/>• GraphQL"]
            CompilerServer["Compiler Server<br/>• Build<br/>• Test"]
        end
    end
    
    subgraph Execution["⚡ Execution Layer"]
        Validator["Parameter Validator<br/>✅ Type Check<br/>✅ Required Fields"]
        Executor["Safe Executor<br/>🔐 Sandboxed<br/>⏱️ Timeout Control"]
        ResultProcessor["Result Processor<br/>📦 Format Output<br/>🎨 Transform Data"]
    end
    
    subgraph Resources["📚 Resource Layer"]
        FileRes["File Resources<br/>📄 Documents<br/>💾 Data Files"]
        PromptRes["Prompt Templates<br/>📝 Reusable<br/>🔄 Parameterized"]
        MetaRes["Metadata<br/>📊 Schemas<br/>🏷️ Tags"]
    end
    
    subgraph Output["📤 Output"]
        ToolResult["Tool Result<br/>- Status<br/>- Content<br/>- Metadata"]
        ResourceData["Resource Data<br/>- Content<br/>- Type<br/>- URI"]
        Error["Error Handling<br/>- Type<br/>- Message<br/>- Recovery"]
    end
    
    %% Connections
    ToolCall --> MCPManager
    ResourceReq --> MCPManager
    PromptReq --> MCPManager
    
    MCPManager --> ServerRegistry
    ServerRegistry --> Router
    Router --> Discovery
    
    Discovery --> Servers
    
    FSServer --> Execution
    CustomServers --> Execution
    
    Execution --> Validator
    Validator --> Executor
    Executor --> ResultProcessor
    
    Resources --> FSServer
    Resources --> CustomServers
    
    ResultProcessor --> ToolResult
    ResultProcessor --> ResourceData
    Executor -.->|On Error| Error
    
    %% Feedback
    ToolResult -.->|Cache| MCPManager
    Error -.->|Retry| Router
    
    style Request fill:#1e293b,stroke:#3b82f6,stroke-width:2px
    style MCPManager fill:#1e3a5f,stroke:#60a5fa,stroke-width:2px
    style Servers fill:#312e4f,stroke:#8b5cf6,stroke-width:2px
    style Execution fill:#1e3a5f,stroke:#10b981,stroke-width:2px
    style Resources fill:#374151,stroke:#f59e0b,stroke-width:2px
    style Output fill:#1e293b,stroke:#ef4444,stroke-width:2px