%%{init: {'theme':'dark', 'themeVariables': { 'primaryColor':'#1f2937', 'primaryTextColor':'#fff', 'primaryBorderColor':'#7C3AED', 'lineColor':'#F59E0B', 'secondaryColor':'#6366F1', 'tertiaryColor':'#10B981'}}}%%

graph TB
    %% MCP Module - Model Context Protocol Implementation
    %% Core infrastructure and filesystem server are implemented
    
    subgraph RequestLayer["üì® Request Layer"]
        ToolCall["Tool Call Request<br/>‚Ä¢ Tool name<br/>‚Ä¢ Arguments dict<br/>‚Ä¢ Validation"]
        
        ResourceRequest["Resource Request<br/>‚Ä¢ Resource URI<br/>‚Ä¢ Resource type<br/>‚Ä¢ Access mode"]
        
        PromptRequest["Prompt Request<br/>üîÆ Future Feature<br/>‚Ä¢ Template loading<br/>‚Ä¢ Variable substitution"]
    end
    
    subgraph MCPCore["üéõÔ∏è MCP Core Infrastructure"]
        
        subgraph Manager["Manager (core/manager.py)"]
            MCPManager["MCP Manager<br/>‚Ä¢ Server registry<br/>‚Ä¢ Tool routing<br/>‚Ä¢ Discovery service"]
            
            ServerRegistry["Server Registry<br/>‚Ä¢ Register servers<br/>‚Ä¢ Lookup by name<br/>‚Ä¢ List all servers"]
            
            ToolRouter["Tool Router<br/>‚Ä¢ Route to server<br/>‚Ä¢ Call tool method<br/>‚Ä¢ Handle response"]
        end
        
        subgraph BaseInfrastructure["Base Infrastructure (core/)"]
            BaseServer["Base Server (base_server.py)<br/>‚Ä¢ Abstract interface<br/>‚Ä¢ Tool registration<br/>‚Ä¢ Error handling"]
            
            BaseClient["Base Client (base_client.py)<br/>‚Ä¢ Client interface<br/>‚Ä¢ Request formatting<br/>‚Ä¢ Response parsing"]
            
            TypeDefinitions["Type Definitions (types.py)<br/>‚Ä¢ ToolCall<br/>‚Ä¢ ToolResult<br/>‚Ä¢ Resource<br/>‚Ä¢ ToolInfo"]
        end
    end
    
    subgraph ImplementedServers["‚úÖ Implemented Servers"]
        
        subgraph FilesystemServer["üìÅ Filesystem Server (servers/filesystem.py)"]
            FSTools["Available Tools:<br/>‚Ä¢ read_file<br/>‚Ä¢ write_file<br/>‚Ä¢ list_directory<br/>‚Ä¢ search_files<br/>‚Ä¢ get_file_info"]
            
            FSSecurity["Security Features:<br/>‚Ä¢ Path validation<br/>‚Ä¢ Access control<br/>‚Ä¢ Size limits<br/>‚Ä¢ Safe operations"]
            
            FSCapabilities["Capabilities:<br/>‚Ä¢ Text files<br/>‚Ä¢ Binary files<br/>‚Ä¢ Directory traversal<br/>‚Ä¢ Pattern matching"]
        end
    end
    
    subgraph FutureServers["üîÆ Future Servers (Conceptual)"]
        DatabaseServer["Database Server<br/>‚Ä¢ SQL queries<br/>‚Ä¢ NoSQL operations<br/>‚Ä¢ Schema management"]
        
        APIServer["API Server<br/>‚Ä¢ REST endpoints<br/>‚Ä¢ GraphQL queries<br/>‚Ä¢ WebSocket support"]
        
        CompilerServer["Compiler Server<br/>‚Ä¢ Code compilation<br/>‚Ä¢ Test execution<br/>‚Ä¢ Build automation"]
    end
    
    subgraph ExecutionFlow["‚ö° Execution Flow"]
        RequestValidation["Request Validation<br/>‚Ä¢ Parameter checking<br/>‚Ä¢ Type validation<br/>‚Ä¢ Permission check"]
        
        ToolExecution["Tool Execution<br/>‚Ä¢ Invoke tool method<br/>‚Ä¢ Handle async ops<br/>‚Ä¢ Capture output"]
        
        ResultProcessing["Result Processing<br/>‚Ä¢ Format response<br/>‚Ä¢ Add metadata<br/>‚Ä¢ Error wrapping"]
    end
    
    subgraph ErrorHandling["‚ö†Ô∏è Error Handling (core/exceptions.py)"]
        MCPException["MCP Exception<br/>‚Ä¢ Base exception<br/>‚Ä¢ Error codes<br/>‚Ä¢ Error messages"]
        
        ValidationError["Validation Error<br/>‚Ä¢ Parameter errors<br/>‚Ä¢ Type mismatches<br/>‚Ä¢ Missing fields"]
        
        ExecutionError["Execution Error<br/>‚Ä¢ Tool failures<br/>‚Ä¢ Timeout errors<br/>‚Ä¢ Permission denied"]
    end
    
    %% Main Flow
    ToolCall --> MCPManager
    ResourceRequest --> MCPManager
    PromptRequest --> MCPManager
    
    MCPManager --> ServerRegistry
    ServerRegistry --> ToolRouter
    
    ToolRouter --> RequestValidation
    RequestValidation --> BaseServer
    
    BaseServer --> FilesystemServer
    BaseServer -.->|Future| DatabaseServer
    BaseServer -.->|Future| APIServer
    BaseServer -.->|Future| CompilerServer
    
    FilesystemServer --> FSTools
    FSTools --> FSSecurity
    FSSecurity --> FSCapabilities
    
    FSCapabilities --> ToolExecution
    ToolExecution --> ResultProcessing
    
    %% Error Flow
    RequestValidation -.->|Invalid| ValidationError
    ToolExecution -.->|Failed| ExecutionError
    ValidationError --> MCPException
    ExecutionError --> MCPException
    
    %% Type System
    ToolCall --> TypeDefinitions
    ResultProcessing --> TypeDefinitions
    BaseServer --> TypeDefinitions
    
    style RequestLayer fill:#1e3a5f,stroke:#3b82f6,stroke-width:2px
    style MCPCore fill:#1e453f,stroke:#10b981,stroke-width:3px
    style ImplementedServers fill:#312e4f,stroke:#8b5cf6,stroke-width:2px
    style FutureServers fill:#2d1b47,stroke:#ec4899,stroke-width:1px,stroke-dasharray: 5 5
    style ExecutionFlow fill:#1e293b,stroke:#f59e0b,stroke-width:2px
    style ErrorHandling fill:#3f2e1e,stroke:#ef4444,stroke-width:2px
    
    %% Implementation Status
    subgraph Legend["üìå Implementation Status"]
        Implemented["‚úÖ Implemented: Manager, Filesystem Server, Base Infrastructure"]
        Planned["üîÆ Planned: Database, API, Compiler servers"]
        Architecture["üèóÔ∏è Ready for extension with new server types"]
    end
    
    style Legend fill:#1a1a2e,stroke:#666,stroke-width:1px,stroke-dasharray: 5 5