%%{init: {'theme':'dark', 'themeVariables': { 'primaryColor':'#1f2937', 'primaryTextColor':'#fff', 'primaryBorderColor':'#7C3AED', 'lineColor':'#F59E0B', 'secondaryColor':'#6366F1', 'tertiaryColor':'#10B981'}}}%%

graph TB
    %% Nighty Code - Complete System Architecture
    
    subgraph UserLayer["ğŸ‘¤ User Layer"]
        Developer[/"Developer<br/>Python Application"/]
        API[/"API Client<br/>REST/GraphQL"/]
        CLI[/"CLI Tool<br/>Command Line"/]
    end
    
    subgraph ApplicationLayer["ğŸ—ï¸ Application Layer"]
        
        subgraph Orchestration["ğŸ­ Orchestration"]
            AppController["Application Controller<br/>â€¢ Request Routing<br/>â€¢ Session Management<br/>â€¢ Error Handling"]
            ConfigManager["Configuration Manager<br/>â€¢ Environment Variables<br/>â€¢ Settings Files<br/>â€¢ Dynamic Config"]
        end
        
        subgraph Integration["ğŸ”— Integration Points"]
            ModuleRouter["Module Router<br/>â€¢ Dynamic Selection<br/>â€¢ Load Balancing<br/>â€¢ Fallback Logic"]
            EventBus["Event Bus<br/>â€¢ Inter-module Communication<br/>â€¢ Event Streaming<br/>â€¢ Notifications"]
        end
    end
    
    subgraph CoreModules["ğŸ§© Core Modules"]
        
        subgraph LLM["ğŸ¤– LLM Module"]
            LLMManager["Manager<br/>+ Providers<br/>+ Middleware<br/>+ Pool"]
        end
        
        subgraph MCP["ğŸ”§ MCP Module"]
            MCPManager["Manager<br/>+ Servers<br/>+ Tools<br/>+ Resources"]
        end
        
        subgraph Copilot["ğŸ§  Copilot Module"]
            CopilotCore["Cognitive Engine<br/>+ Memory<br/>+ Reasoning<br/>+ Workflows"]
        end
        
        subgraph DataMiner["â›ï¸ DataMiner Module"]
            DataMinerCore["Extraction Engine<br/>+ Strategies<br/>+ Validation<br/>+ Intelligence"]
        end
    end
    
    subgraph SharedServices["ğŸ› ï¸ Shared Services"]
        
        subgraph DataServices["ğŸ’¾ Data Services"]
            Cache["Cache Layer<br/>â€¢ Redis/Memory<br/>â€¢ TTL Management<br/>â€¢ Invalidation"]
            Storage["Storage Layer<br/>â€¢ File System<br/>â€¢ Database<br/>â€¢ Object Store"]
        end
        
        subgraph SecurityServices["ğŸ” Security Services"]
            Auth["Authentication<br/>â€¢ API Keys<br/>â€¢ OAuth<br/>â€¢ JWT"]
            RateLimit["Rate Limiting<br/>â€¢ Per User<br/>â€¢ Per API<br/>â€¢ Global"]
            Encryption["Encryption<br/>â€¢ Data at Rest<br/>â€¢ Data in Transit<br/>â€¢ Key Management"]
        end
        
        subgraph ObservabilityServices["ğŸ“Š Observability"]
            Logging["Logging<br/>â€¢ Structured Logs<br/>â€¢ Log Aggregation<br/>â€¢ Search"]
            Metrics["Metrics<br/>â€¢ Performance<br/>â€¢ Usage<br/>â€¢ Costs"]
            Tracing["Tracing<br/>â€¢ Distributed<br/>â€¢ Request Flow<br/>â€¢ Bottlenecks"]
        end
    end
    
    subgraph ExternalServices["â˜ï¸ External Services"]
        
        subgraph AIProviders["ğŸ¤– AI Providers"]
            Anthropic["Anthropic<br/>Claude API"]
            OpenAI["OpenAI<br/>GPT API"]
            Custom["Custom<br/>Self-hosted"]
        end
        
        subgraph DataSources["ğŸ“š Data Sources"]
            FileSystem["File System<br/>Local/Network"]
            Databases["Databases<br/>SQL/NoSQL"]
            APIs["External APIs<br/>REST/GraphQL"]
        end
    end
    
    subgraph DataFlow["ğŸ“Š Data Flow Examples"]
        
        subgraph Flow1["Example: Code Analysis"]
            F1_1["User Request"] --> F1_2["Copilot Plans"]
            F1_2 --> F1_3["MCP Reads Files"]
            F1_3 --> F1_4["DataMiner Extracts"]
            F1_4 --> F1_5["LLM Analyzes"]
            F1_5 --> F1_6["Response"]
        end
        
        subgraph Flow2["Example: Document Generation"]
            F2_1["User Query"] --> F2_2["DataMiner Gathers"]
            F2_2 --> F2_3["Copilot Reasons"]
            F2_3 --> F2_4["LLM Generates"]
            F2_4 --> F2_5["MCP Writes"]
            F2_5 --> F2_6["Output"]
        end
    end
    
    %% Main Connections
    Developer --> AppController
    API --> AppController
    CLI --> AppController
    
    AppController --> ModuleRouter
    ConfigManager --> ModuleRouter
    
    ModuleRouter --> LLM
    ModuleRouter --> MCP
    ModuleRouter --> Copilot
    ModuleRouter --> DataMiner
    
    %% Module Interactions
    Copilot -.->|Uses| LLM
    Copilot -.->|Uses| MCP
    DataMiner -.->|Uses| LLM
    DataMiner -.->|Uses| MCP
    
    %% Shared Services
    LLM --> Cache
    MCP --> Storage
    Copilot --> Cache
    DataMiner --> Storage
    
    AppController --> Auth
    AppController --> RateLimit
    
    %% External Connections
    LLM --> AIProviders
    MCP --> FileSystem
    DataMiner --> Databases
    
    %% Observability
    LLM -.->|Logs| Logging
    MCP -.->|Metrics| Metrics
    Copilot -.->|Traces| Tracing
    DataMiner -.->|Logs| Logging
    
    %% Event Bus
    EventBus -.->|Events| LLM
    EventBus -.->|Events| MCP
    EventBus -.->|Events| Copilot
    EventBus -.->|Events| DataMiner
    
    style UserLayer fill:#1e293b,stroke:#3b82f6,stroke-width:2px
    style ApplicationLayer fill:#1e3a5f,stroke:#60a5fa,stroke-width:2px
    style CoreModules fill:#312e4f,stroke:#8b5cf6,stroke-width:3px
    style SharedServices fill:#1e453f,stroke:#10b981,stroke-width:2px
    style ExternalServices fill:#3f2e1e,stroke:#f59e0b,stroke-width:2px
    style DataFlow fill:#2d1b47,stroke:#ec4899,stroke-width:2px